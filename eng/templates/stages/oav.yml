extends:
  template: /eng/pipelines/templates/stages/1es-redirect.yml
  parameters:
    stages:
      - stage: Build
        variables:
          - name: Artifacts
            value: $(Pipeline.Workspace)/artifacts
          - template: /eng/pipelines/templates/variables/image.yml

        jobs:
          - job: Build



            steps:
            - checkout: self
              submodules: true
            - task: Npm@1
              displayName: "npm ci"
              inputs:
                command: ci
                verbose: false

            - task: Npm@1
              displayName: "npm run build"
              inputs:
                command: custom
                verbose: false
                customCommand: run build

            - task: Npm@1
              displayName: "npm test"
              inputs:
                command: custom
                verbose: false
                customCommand: test

            - task: PublishTestResults@2
              inputs:
                testResultsFiles: "**/test-results.xml"
                testRunTitle: "Test results for JavaScript"

            - task: PublishCodeCoverageResults@1
              inputs:
                codeCoverageTool: Cobertura
                summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/*coverage.xml"
                reportDirectory: "$(System.DefaultWorkingDirectory)/**/coverage"

            - task: Npm@1
              displayName: "npm pack"
              inputs:
                command: custom
                verbose: false
                customCommand: pack

            - task: CopyFiles@2
              displayName: "Copy Files to: drop"
              inputs:
                Contents: "*.tgz"
                TargetFolder: drop

            - task: PublishBuildArtifacts@1
              inputs:
                pathtoPublish: $(Build.SourcesDirectory)/drop

          - job: Test
            steps:
            - checkout: self
              submodules: true

            - task: Npm@1
              displayName: "npm ci"
              inputs:
                command: ci
                verbose: false

            - task: Npm@1
              displayName: "npm run build"
              inputs:
                command: custom
                verbose: false
                customCommand: run build

            - task: Npm@1
              displayName: "npm test"
              inputs:
                command: custom
                verbose: false
                customCommand: test

            - task: PublishTestResults@2
              inputs:
                testResultsFiles: "**/test-results.xml"
                testRunTitle: "Test results for JavaScript"

            - task: PublishCodeCoverageResults@1
              inputs:
                codeCoverageTool: Cobertura
                summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/*coverage.xml"
                reportDirectory: "$(System.DefaultWorkingDirectory)/**/coverage"

            - task: Npm@1
              displayName: "npm pack"
              inputs:
                command: custom
                verbose: false
                customCommand: pack

            - task: CopyFiles@2
              displayName: "Copy Files to: drop"
              inputs:
                Contents: "*.tgz"
                TargetFolder: drop

            - task: PublishBuildArtifacts@1
              inputs:
                pathtoPublish: $(Build.SourcesDirectory)/drop

      # only include if running on `internal` build, otherwise never include
      - ${{ if }}